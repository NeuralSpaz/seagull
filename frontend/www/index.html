<!doctype html>
<!-- Copyright seagull Authors All rights reserved -->
<!-- Please see  github.com//notthegoodorthebad/seagull/ for Licence-->
<html>
<head>
	<script async defer
		src="styles.js">
	</script>
	<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBj_B8fJmNw2_QFQMypsw_9dYXOe5wB13Q&callback=initMap">
	</script>
	

	<style>
	html, body, #map {
		padding: 0px;
		margin: 0px;
		width: 100%;
		height: 100%;
		overflow: hidden;
	}
    </style>
</head>

<body >
		<div id="map"></div>
<script>
	var map
	var Networks =[];
	var infoOpen
	function initMap() {
		var myLatlng = {lat: -25.363, lng: 131.044};
	  
		map = new google.maps.Map(document.getElementById('map'), {
		  zoom: 4,
		  center: myLatlng,
		  styles: styles
		});
	  
		var iconBase = 'https://127.0.0.1:8080/bike.svg';
		var icons = {
			info: {
            icon: iconBase + 'bike.svg'
          }
		}
		window.setTimeout(function() {
			load("/api/network");	
    	}, 1);
	  }



	function load(url,lat,lng) {
		var xhr = new XMLHttpRequest();
		if ((lat != undefined) && (lng != undefined)) {
			url = url + "?Lat=" + lat +"&Lng=" + lng +"&Rng=1000000"
		}
		console.log(url)
		xhr.open('GET', url);
		xhr.responseType = 'json';
				
		xhr.onload = function(e) {
		    if (this.status == 200) {
                console.log(this.response)
				if (this.response != null) {
					Networks = this.response;
					for (var i=0; i< Networks.length; i++){
						addNetworkMarker(Networks[i].location.latitude, Networks[i].location.longitude, Networks[i].id)
					}
				}
			}
		}
		xhr.send();
	};

	function loadStations(id) {
		var xhr = new XMLHttpRequest();
		var url = "/api/network/" + id
		console.log(url)
		xhr.open('GET', url);
		xhr.responseType = 'json';
				
		xhr.onload = function(e) {
		    if (this.status == 200) {
                console.log(this.response)
				if (this.response != null) {
					detail = this.response;
					for (var i=0; i< detail.stations.length; i++){
						addStationMarker(detail.stations[i].latitude, detail.stations[i].longitude, detail.stations[i])
					}
				}
			}
		}
		xhr.send();
	};

	function addNetworkMarker(lat, lng, name) {
		var marker = new google.maps.Marker({
			position: {lat: lat, lng: lng}, 
			map: map,
			title: name,
			icon: {
				url: 'http://127.0.0.1:8080/bike.png',
				size: new google.maps.Size(32, 32),
			}
		});
		marker.addListener('click', function() {
          // 3 seconds after the center of the map has changed, pan back to the
		window.setTimeout(function() {
			loadStations(marker.title);	
			// console.log(marker.title)
		}, 1);
		
          window.setTimeout(function() {
			map.setZoom(15);
            map.panTo(marker.getPosition());
          }, 300);
		});

	}

	function addStationMarker(lat, lng, station) {
		var marker = new google.maps.Marker({
			position: {lat: lat, lng: lng}, 
			map: map,
			title: station.name,
			icon: {
				url: 'http://127.0.0.1:8080/helmet.png',
				size: new google.maps.Size(32, 32),
				origin: new google.maps.Point(0, 0),
				anchor: new google.maps.Point(16, 16)
			}
		});
		var infowindow = new google.maps.InfoWindow({
			content: "Free: "+ station.free_bikes.toString()
		});
		marker.addListener('click', function() {
			if (typeof infowindow)
			infowindow.open(map,marker)
		})
		// marker.addListener('click', function() {
        //   // 3 seconds after the center of the map has changed, pan back to the
		// window.setTimeout(function() {
		// 	load("/api/network/" + marker.title);	
		// 	// console.log(marker.title)
		// }, 1);
		
        //   window.setTimeout(function() {
        //     map.panTo(marker.getPosition());
        //   }, 3000);
        // });
	}

</script>
</body>
